# PowerInfer with ROCm for AMD Strix APUs
#
# GPU Targets:
#   Strix Halo (gfx1151): use :latest image, HSA_OVERRIDE_GFX_VERSION=11.5.1
#   Strix Point (gfx1150): use :gfx1150-latest image, HSA_OVERRIDE_GFX_VERSION=11.5.0

services:
  powerinfer:
    # For Strix Point, change to: ghcr.io/cecil-the-coder/powerinfer-strix-halo-rocm:gfx1150-latest
    image: ghcr.io/cecil-the-coder/powerinfer-strix-halo-rocm:latest
    devices:
      - /dev/kfd:/dev/kfd
      - /dev/dri:/dev/dri
    volumes:
      - ./models:/models
    ports:
      - "8080:8080"
    environment:
      # For Strix Point, change to: HSA_OVERRIDE_GFX_VERSION=11.5.0
      - HSA_OVERRIDE_GFX_VERSION=11.5.1
      - ROCBLAS_USE_HIPBLASLT=1
    command:
      - ./server
      - --model
      - /models/llama-2-7b-relu.powerinfer.gguf
      - --ctx-size
      - "4096"
      - --n-gpu-layers
      - "999"
      - --host
      - "0.0.0.0"
      - --port
      - "8080"
